# Настройки Apache
# Включить mod_rewrite
RewriteEngine On
RewriteBase /

# Переадресация с www на без www (без принудительного HTTPS — SSL и редирект на HTTPS настраиваются на уровне хостинга/прокси, иначе возможен цикл редиректов)
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
# Разрешить доступ к robots.txt и sitemap.xml
<Files "robots.txt">
    Order allow,deny
    Allow from all
    <IfModule mod_headers.c>
        Header set Content-Type "text/plain; charset=utf-8"
    </IfModule>
</Files>
<Files "sitemap.xml">
    Order allow,deny
    Allow from all
    <IfModule mod_headers.c>
        Header set Content-Type "application/xml; charset=utf-8"
    </IfModule>
</Files>
# Защита файлов конфигурации
<FilesMatch "\.(env|sql|md|log|ini)$">
    Order allow,deny
    Deny from all
</FilesMatch>
# Защита служебных директорий
RedirectMatch 403 ^/includes/
RedirectMatch 403 ^/\.git
# PHP настройки
<IfModule mod_php8.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value memory_limit 256M
    php_value session.gc_maxlifetime 7776000
</IfModule>
# Кэширование статических файлов
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType image/x-icon "access plus 1 year"
</IfModule>
# Сжатие
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>
# Безопасность
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
# Отключить листинг директорий
Options -Indexes
# Профили пользователей: /username -> profile.php?username=username
# Исключаем существующие файлы и папки
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/(admin|api|assets|auth|bot|database|favicons|includes|pages|photos|routes|uploads|webapp)/
RewriteCond %{REQUEST_URI} ^/([a-zA-Z0-9_]+)/?$
RewriteRule ^([a-zA-Z0-9_]+)/?$ /profile.php?username=$1 [L,QSA]

# Индексные файлы
DirectoryIndex index.php index.html
# Кастомные страницы ошибок
ErrorDocument 404 /404.php
ErrorDocument 403 /403.php
ErrorDocument 500 /500.php