<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
require_once __DIR__ . '/db.php';
function getCurrentLanguage() {
    if (isset($_GET['lang']) && in_array($_GET['lang'], ['ru', 'en'])) {
        $lang = $_GET['lang'];
        setLanguage($lang);
        return $lang;
    }
    if (function_exists('isLoggedIn') && isLoggedIn()) {
        $user = getCurrentUser();
        if ($user && isset($user['language']) && !empty($user['language'])) {
            return $user['language'];
        }
    }
    if (isset($_SESSION['language'])) {
        return $_SESSION['language'];
    }
    return 'ru';
}
function setLanguage($lang) {
    $_SESSION['language'] = $lang;
    if (function_exists('isLoggedIn') && isLoggedIn()) {
        $user = getCurrentUser();
        if ($user && isset($user['id'])) {
            try {
                $pdo = getDB()->getConnection();
                $stmt = $pdo->prepare("UPDATE users SET language = ? WHERE id = ?");
                $stmt->execute([$lang, $user['id']]);
            } catch (Exception $e) {
                error_log("Error updating user language: " . $e->getMessage());
            }
        }
    }
}
$translations = [
    'ru' => [
        'site_name' => 'QuestGuideRF',
        'home' => 'Главная',
        'routes' => 'Экскурсии',
        'photos' => 'Фото',
        'payments' => 'Покупки',
        'bank' => 'Банк',
        'achievements' => 'Достижения',
        'reviews' => 'Отзывы',
        'certificates' => 'Сертификаты',
        'no_certificates' => 'У вас пока нет сертификатов',
        'complete_quest_for_certificate' => 'Завершите квест, чтобы получить сертификат',
        'view_routes' => 'Посмотреть маршруты',
        'create_certificates_for_completed' => 'Создать сертификаты для завершенных квестов',
        'create_certificate' => 'Создать сертификат',
        'creating' => 'Создание',
        'created' => 'Создано',
        'settings' => 'Настройки',
        'about' => 'О нас',
        'contact' => 'Контакты',
        'login' => 'Войти',
        'logout' => 'Выйти',
        'admin_panel' => 'Админ-панель',
        'select_city' => 'Выберите город',
        'select_route' => 'Выберите маршрут',
        'price' => 'Цена',
        'duration' => 'Длительность',
        'difficulty' => 'Сложность',
        'start_quest' => 'Начать квест',
        'view_details' => 'Подробнее',
        'no_routes' => 'Маршруты не найдены',
        'write_review' => 'Написать отзыв',
        'rating' => 'Рейтинг',
        'your_rating' => 'Ваша оценка',
        'your_review' => 'Ваш отзыв',
        'submit' => 'Отправить',
        'cancel' => 'Отмена',
        'points' => 'Точек',
        'time' => 'Время',
        'distance' => 'Расстояние',
        'free' => 'Бесплатно',
        'paid' => 'Платно',
        'completed' => 'Завершено',
        'in_progress' => 'В процессе',
        'not_started' => 'Не начато',
        'my_stats' => 'Моя статистика',
        'total_routes' => 'Всего маршрутов',
        'completed_routes' => 'Завершено маршрутов',
        'total_points' => 'Всего точек',
        'completed_points' => 'Пройдено точек',
        'total_time' => 'Общее время',
        'total_distance' => 'Общее расстояние',
        'no_data' => 'Нет данных',
        'settings_title' => 'Настройки',
        'settings_subtitle' => 'Управление аккаунтом и предпочтениями',
        'profile' => 'Профиль',
        'change_avatar' => 'Изменить',
        'avatar_upload_hint' => 'Данные синхронизируются с вашим профилем Telegram автоматически. Вы можете загрузить собственный аватар (макс. 5 МБ).',
        'appearance' => 'Внешний вид',
        'theme' => 'Тема оформления',
        'theme_description' => 'Выберите светлую или тёмную тему',
        'theme_light' => 'Светлая',
        'theme_dark' => 'Тёмная',
        'theme_auto' => 'Авто',
        'language_setting' => 'Язык интерфейса',
        'language_description' => 'Выберите язык для интерфейса сайта и бота',
        'language_russian' => 'Русский',
        'language_english' => 'English',
        'statistics' => 'Статистика',
        'registration_date' => 'Дата регистрации:',
        'last_login' => 'Последний вход:',
        'telegram_bot' => 'Telegram бот',
        'telegram_bot_description' => 'Взаимодействуйте с ботом для прохождения квестов и получения достижений.',
        'open_bot' => 'Открыть бота',
        'logout' => 'Выход из аккаунта',
        'logout_description' => 'Вы будете перенаправлены на страницу входа.',
        'logout_button' => 'Выйти',
        'uploading' => 'Загрузка...',
        'avatar_updated' => 'Аватар успешно обновлён!',
        'upload_error' => 'Ошибка загрузки',
        'file_too_large' => 'Размер файла не должен превышать 5 МБ',
        'invalid_file_type' => 'Разрешены только изображения: JPG, PNG, GIF, WEBP',
        'hello' => 'Привет',
        'level' => 'Уровень',
        'routes_completed' => 'Пройдено маршрутов',
        'points_completed' => 'Пройдено точек',
        'time_in_quests' => 'Время в квестах',
        'achievements' => 'Достижений',
        'active_quests' => 'Активные квесты',
        'all_routes' => 'Все маршруты',
        'completed_progress' => 'Пройдено',
        'continue_in_bot' => 'Продолжить в боте',
        'quick_actions' => 'Быстрые действия',
        'my_routes' => 'Мои экскурсии',
        'photos' => 'Фотографии',
        'purchases' => 'Покупки',
        'open_bot' => 'Открыть бота',
        'reviews_title' => 'Отзывы',
        'reviews_subtitle' => 'Что говорят наши пользователи о квестах',
        'total_reviews' => 'Всего отзывов',
        'routes_with_reviews' => 'Маршрутов с отзывами',
        'route_filter' => 'Маршрут',
        'all_routes_filter' => 'Все маршруты',
        'rating_filter' => 'Рейтинг',
        'any_rating' => 'Любой',
        'search' => 'Найти',
        'reset' => 'Сбросить',
        'no_reviews' => 'Пока нет отзывов',
        'recent_achievements' => 'Последние достижения',
        'all_achievements' => 'Все достижения',
        'my_routes_title' => 'Мои экскурсии',
        'my_routes_subtitle' => 'Все ваши пройденные и текущие маршруты',
        'no_routes_yet' => 'У вас пока нет экскурсий',
        'start_first_adventure' => 'Начните свое первое приключение в боте!',
        'in_progress' => 'В процессе',
        'completed' => 'Завершено',
        'abandoned' => 'Прервано',
        'continue_quest' => 'Продолжить квест',
        'view_details' => 'Подробнее',
        'photos_title' => 'Фотографии',
        'photos_subtitle' => 'Ваши снимки из квестов',
        'filter_by_route' => 'Фильтр по маршруту:',
        'all_routes_filter' => 'Все маршруты',
        'no_photos_yet' => 'Пока нет фотографий',
        'start_quest_and_photo' => 'Начните квест и делайте снимки!',
        'file_not_found' => 'Файл не найден',
        'payments_title' => 'История покупок',
        'payments_subtitle' => 'Все ваши платежи и покупки',
        'total_spent' => 'Всего потрачено',
        'total_purchases' => 'Всего покупок',
        'no_purchases_yet' => 'Пока нет покупок',
        'buy_first_route' => 'Приобретите первый маршрут в боте!',
        'payment_id' => 'ID',
        'achievements_title' => 'Достижения',
        'achievements_subtitle' => 'Собирайте достижения, проходя квесты',
        'progress' => 'Прогресс',
        'achievements_earned' => 'достижений получено',
        'earned' => 'Получено',
        'hidden_achievement' => 'Скрытое достижение',
        'task' => 'Задание',
        'min_people' => 'Минимум людей',
        'started' => 'Начато',
        'photos_button' => 'Фотографии',
        'pose_required' => 'Требуется поза',
        'pose_hands_up' => 'Руки вверх',
        'pose_heart' => 'Сердечко',
        'pose_point' => 'Указать',
        'points' => 'точек',
        'all_routes' => 'Все экскурсии',
        'available_routes' => 'Доступные экскурсии',
        'view_details' => 'Подробнее',
        'start_quest' => 'Начать квест',
        'city' => 'Город',
        'all_cities' => 'Все города',
        'type' => 'Тип',
        'all_types' => 'Все типы',
        'walking' => 'Пешком',
        'cycling' => 'На велосипеде',
        'any_difficulty' => 'Любая',
        'easy' => 'Легкая',
        'medium' => 'Средняя',
        'hard' => 'Сложная',
        'tag' => 'Тег',
        'all_tags' => 'Все теги',
        'sort_by' => 'Сортировать по',
        'sort_name' => 'Названию',
        'sort_price' => 'Цене',
        'sort_duration' => 'Длительности',
        'sort_distance' => 'Расстоянию',
        'order' => 'Порядок',
        'ascending' => 'По возрастанию',
        'descending' => 'По убыванию',
        'apply_filters' => 'Применить',
        'bank_title' => 'Банк токенов',
        'bank_subtitle' => 'Баланс, пополнения и покупки экскурсий',
        'bank_balance' => 'Баланс',
        'bank_total_deposited' => 'Всего пополнено',
        'bank_total_spent' => 'Всего потрачено',
        'bank_total_transferred' => 'Всего переведено',
        'bank_purchases' => 'Покупки',
        'bank_bot_hint' => 'Пополнить баланс, перевести токены и купить экскурсии можно в боте:',
    ],
    'en' => [
        'site_name' => 'QuestGuideRF',
        'home' => 'Home',
        'routes' => 'Routes',
        'photos' => 'Photos',
        'payments' => 'Purchases',
        'bank' => 'Bank',
        'achievements' => 'Achievements',
        'reviews' => 'Reviews',
        'certificates' => 'Certificates',
        'no_certificates' => 'You have no certificates yet',
        'complete_quest_for_certificate' => 'Complete a quest to get a certificate',
        'view_routes' => 'View routes',
        'create_certificates_for_completed' => 'Create certificates for completed quests',
        'create_certificate' => 'Create certificate',
        'creating' => 'Creating',
        'created' => 'Created',
        'settings' => 'Settings',
        'about' => 'About',
        'contact' => 'Contact',
        'login' => 'Login',
        'logout' => 'Logout',
        'admin_panel' => 'Admin Panel',
        'select_city' => 'Select City',
        'select_route' => 'Select Route',
        'price' => 'Price',
        'duration' => 'Duration',
        'difficulty' => 'Difficulty',
        'start_quest' => 'Start Quest',
        'view_details' => 'View Details',
        'no_routes' => 'No routes found',
        'write_review' => 'Write Review',
        'rating' => 'Rating',
        'your_rating' => 'Your Rating',
        'your_review' => 'Your Review',
        'submit' => 'Submit',
        'cancel' => 'Cancel',
        'points' => 'Points',
        'time' => 'Time',
        'distance' => 'Distance',
        'free' => 'Free',
        'paid' => 'Paid',
        'completed' => 'Completed',
        'in_progress' => 'In Progress',
        'not_started' => 'Not Started',
        'my_stats' => 'My Stats',
        'total_routes' => 'Total Routes',
        'completed_routes' => 'Completed Routes',
        'total_points' => 'Total Points',
        'completed_points' => 'Completed Points',
        'total_time' => 'Total Time',
        'total_distance' => 'Total Distance',
        'no_data' => 'No Data',
        'settings_title' => 'Settings',
        'settings_subtitle' => 'Account and preferences management',
        'profile' => 'Profile',
        'change_avatar' => 'Change',
        'avatar_upload_hint' => 'Data is automatically synced with your Telegram profile. You can upload your own avatar (max. 5 MB).',
        'appearance' => 'Appearance',
        'theme' => 'Theme',
        'theme_description' => 'Choose light or dark theme',
        'theme_light' => 'Light',
        'theme_dark' => 'Dark',
        'theme_auto' => 'Auto',
        'language_setting' => 'Interface Language',
        'language_description' => 'Choose language for website and bot interface',
        'language_russian' => 'Russian',
        'language_english' => 'English',
        'statistics' => 'Statistics',
        'registration_date' => 'Registration Date:',
        'last_login' => 'Last Login:',
        'telegram_bot' => 'Telegram Bot',
        'telegram_bot_description' => 'Interact with the bot to complete quests and earn achievements.',
        'open_bot' => 'Open Bot',
        'logout' => 'Logout',
        'logout_description' => 'You will be redirected to the login page.',
        'logout_button' => 'Logout',
        'uploading' => 'Uploading...',
        'avatar_updated' => 'Avatar updated successfully!',
        'upload_error' => 'Upload Error',
        'file_too_large' => 'File size must not exceed 5 MB',
        'invalid_file_type' => 'Only images allowed: JPG, PNG, GIF, WEBP',
        'hello' => 'Hello',
        'level' => 'Level',
        'routes_completed' => 'Routes Completed',
        'points_completed' => 'Points Completed',
        'time_in_quests' => 'Time in Quests',
        'achievements' => 'Achievements',
        'active_quests' => 'Active Quests',
        'all_routes' => 'All Routes',
        'available_routes' => 'Available Routes',
        'completed_progress' => 'Completed',
        'continue_in_bot' => 'Continue in Bot',
        'quick_actions' => 'Quick Actions',
        'my_routes' => 'My Routes',
        'photos' => 'Photos',
        'purchases' => 'Purchases',
        'open_bot' => 'Open Bot',
        'reviews_title' => 'Reviews',
        'reviews_subtitle' => 'What our users say about quests',
        'total_reviews' => 'Total Reviews',
        'routes_with_reviews' => 'Routes with Reviews',
        'route_filter' => 'Route',
        'all_routes_filter' => 'All Routes',
        'rating_filter' => 'Rating',
        'any_rating' => 'Any',
        'search' => 'Search',
        'reset' => 'Reset',
        'no_reviews' => 'No reviews yet',
        'recent_achievements' => 'Recent Achievements',
        'all_achievements' => 'All Achievements',
        'my_routes_title' => 'My Routes',
        'my_routes_subtitle' => 'All your completed and current routes',
        'no_routes_yet' => 'You have no routes yet',
        'start_first_adventure' => 'Start your first adventure in the bot!',
        'in_progress' => 'In Progress',
        'completed' => 'Completed',
        'abandoned' => 'Abandoned',
        'continue_quest' => 'Continue Quest',
        'view_details' => 'View Details',
        'photos_title' => 'Photos',
        'photos_subtitle' => 'Your photos from quests',
        'filter_by_route' => 'Filter by Route:',
        'all_routes_filter' => 'All Routes',
        'no_photos_yet' => 'No photos yet',
        'start_quest_and_photo' => 'Start a quest and take photos!',
        'file_not_found' => 'File not found',
        'payments_title' => 'Purchase History',
        'payments_subtitle' => 'All your payments and purchases',
        'total_spent' => 'Total Spent',
        'total_purchases' => 'Total Purchases',
        'no_purchases_yet' => 'No purchases yet',
        'buy_first_route' => 'Buy your first route in the bot!',
        'payment_id' => 'ID',
        'achievements_title' => 'Achievements',
        'achievements_subtitle' => 'Collect achievements by completing quests',
        'progress' => 'Progress',
        'achievements_earned' => 'achievements earned',
        'earned' => 'Earned',
        'hidden_achievement' => 'Hidden Achievement',
        'task' => 'Task',
        'min_people' => 'Min People',
        'started' => 'Started',
        'photos_button' => 'Photos',
        'pose_required' => 'Pose Required',
        'pose_hands_up' => 'Hands Up',
        'pose_heart' => 'Heart',
        'pose_point' => 'Point',
        'points' => 'points',
        'all_routes' => 'All Available Routes',
        'view_details' => 'View Details',
        'start_quest' => 'Start Quest',
        'city' => 'City',
        'all_cities' => 'All Cities',
        'type' => 'Type',
        'all_types' => 'All Types',
        'walking' => 'Walking',
        'cycling' => 'Cycling',
        'any_difficulty' => 'Any',
        'easy' => 'Easy',
        'medium' => 'Medium',
        'hard' => 'Hard',
        'tag' => 'Tag',
        'all_tags' => 'All Tags',
        'sort_by' => 'Sort By',
        'sort_name' => 'Name',
        'sort_price' => 'Price',
        'sort_duration' => 'Duration',
        'sort_distance' => 'Distance',
        'order' => 'Order',
        'ascending' => 'Ascending',
        'descending' => 'Descending',
        'apply_filters' => 'Apply',
        'bank_title' => 'Token Bank',
        'bank_subtitle' => 'Balance, top-ups and tour purchases',
        'bank_balance' => 'Balance',
        'bank_total_deposited' => 'Total deposited',
        'bank_total_spent' => 'Total spent',
        'bank_total_transferred' => 'Total transferred',
        'bank_purchases' => 'Purchases',
        'bank_bot_hint' => 'Top up, transfer tokens and buy tours in the Telegram bot:',
    ]
];
function t($key, $lang = null) {
    global $translations;
    $lang = $lang ?? getCurrentLanguage();
    return $translations[$lang][$key] ?? $key;
}
function getLocalizedName($item, $lang = null) {
    $lang = $lang ?? getCurrentLanguage();
    if ($lang === 'en' && isset($item['name_en']) && !empty($item['name_en'])) {
        return $item['name_en'];
    }
    return $item['name'] ?? '';
}
function getLocalizedDescription($item, $lang = null) {
    $lang = $lang ?? getCurrentLanguage();
    if ($lang === 'en' && isset($item['description_en']) && !empty($item['description_en'])) {
        return $item['description_en'];
    }
    return $item['description'] ?? '';
}